# 📱 推送功能测试指南

## 🎯 测试目标

验证Expo推送通知的完整功能，包括：
- 推送权限获取
- 推送令牌管理
- 推送消息发送
- 深度链接跳转
- 多语言支持

## 🚀 快速开始

### 1. 启动应用
```bash
# 启动开发服务器
npx expo start

# 在手机上打开Expo Go，扫描二维码
```

### 2. 进入测试页面
- 在主页面点击 "🔔 推送测试" 按钮
- 或者直接访问 `/push-test` 路由

### 3. 基础测试流程
1. **初始化推送服务** → 点击"初始化推送服务"
2. **获取推送权限** → 点击"请求推送权限"
3. **测试本地推送** → 选择推送类型进行测试
4. **验证深度链接** → 点击推送通知，确认页面跳转

## 📋 详细测试步骤

### 方法一：应用内测试（本地推送）

#### 步骤1：权限设置
```
1. 打开推送测试页面
2. 点击"初始化推送服务"
3. 点击"请求推送权限"
4. 在弹出的权限对话框中选择"允许"
```

#### 步骤2：测试推送类型
```
测试以下推送类型：
✅ 申购完成推送
✅ 赎回完成推送  
✅ 身份认证成功推送
✅ 结单生成推送
```

#### 步骤3：验证跳转
```
1. 点击推送通知
2. 确认应用打开并跳转到正确页面
3. 验证推送数据是否正确传递
```

### 方法二：外部推送测试（真实推送）

#### 步骤1：获取推送令牌
```
1. 在推送测试页面查看"推送令牌"
2. 点击"复制完整令牌"
3. 保存令牌用于外部测试
```

#### 步骤2：使用应用内外部测试
```
1. 在"外部推送测试"区域
2. 粘贴推送令牌
3. 自定义标题和内容
4. 点击"🚀 发送外部推送"
```

#### 步骤3：使用命令行测试
```bash
# 基础测试
node scripts/test-push.js "ExponentPushToken[your-token-here]"

# 自定义消息
node scripts/test-push.js "ExponentPushToken[your-token-here]" "交易提醒" "申购完成"
```

#### 步骤4：使用curl测试
```bash
curl -H "Content-Type: application/json" \
     -X POST \
     -d '{
       "to": "ExponentPushToken[your-token-here]",
       "title": "测试推送",
       "body": "这是一条测试消息",
       "data": {"screen": "transaction"},
       "sound": "default",
       "badge": 1
     }' \
     https://exp.host/--/api/v2/push/send
```

### 方法三：在线工具测试

#### 使用Expo官方工具
```
1. 访问: https://expo.dev/notifications
2. 输入推送令牌
3. 填写消息内容
4. 点击发送
```

#### 使用Postman测试
```
URL: https://exp.host/--/api/v2/push/send
Method: POST
Headers: Content-Type: application/json
Body: {
  "to": "ExponentPushToken[your-token-here]",
  "title": "测试推送",
  "body": "测试消息",
  "data": {"screen": "transaction"}
}
```

## 🔍 测试检查清单

### ✅ 基础功能测试
- [ ] 推送服务初始化成功
- [ ] 推送权限获取成功
- [ ] 推送令牌生成正确
- [ ] 本地推送发送成功
- [ ] 推送通知显示正常

### ✅ 深度链接测试
- [ ] 点击推送能打开应用
- [ ] 跳转到正确的页面
- [ ] 推送数据正确传递
- [ ] 应用在后台时跳转正常
- [ ] 应用关闭时跳转正常

### ✅ 多语言测试
- [ ] 中文推送消息正确
- [ ] 英文推送消息正确
- [ ] 语言切换后推送正确

### ✅ 外部推送测试
- [ ] 命令行推送发送成功
- [ ] curl推送发送成功
- [ ] 在线工具推送成功
- [ ] 应用内外部推送成功

### ✅ 错误处理测试
- [ ] 无效令牌处理正确
- [ ] 网络错误处理正确
- [ ] 权限被拒绝处理正确
- [ ] 推送发送失败处理正确

## 🚨 常见问题解决

### 问题1：推送权限被拒绝
```
解决方案:
1. 到设备设置 → 应用 → Expo Go → 通知
2. 开启通知权限
3. 重新启动应用
4. 重新请求权限
```

### 问题2：推送令牌获取失败
```
解决方案:
1. 确保使用真实设备（不是模拟器）
2. 检查网络连接
3. 重新初始化推送服务
4. 检查app.json配置
```

### 问题3：推送发送失败
```
解决方案:
1. 验证推送令牌格式
2. 检查令牌是否过期
3. 确认设备在线
4. 重新获取推送令牌
```

### 问题4：深度链接不工作
```
解决方案:
1. 检查app.json中的scheme配置
2. 验证推送数据格式
3. 确认路由配置正确
4. 检查_layout.tsx中的链接处理
```

### 问题5：推送收不到
```
解决方案:
1. 确保应用在前台或后台运行
2. 检查设备通知设置
3. 验证推送令牌有效性
4. 确认网络连接正常
```

## 📊 测试结果记录

### 测试环境
- [ ] iOS设备测试
- [ ] Android设备测试
- [ ] 不同网络环境测试
- [ ] 不同应用状态测试

### 性能指标
- 推送发送成功率: ____%
- 推送送达率: ____%
- 深度链接成功率: ____%
- 平均响应时间: ____ms

### 测试记录
```
测试时间: ________________
测试设备: ________________
测试结果: ________________
问题记录: ________________
解决方案: ________________
```

## 🎯 生产环境准备

### 配置检查
- [ ] 更新真实的Expo项目ID
- [ ] 配置iOS推送证书
- [ ] 配置Android FCM
- [ ] 移除测试页面和按钮

### 后端集成
- [ ] 实现推送令牌保存API
- [ ] 实现推送发送API
- [ ] 配置推送消息模板
- [ ] 实现推送统计和监控

### 监控设置
- [ ] 推送发送监控
- [ ] 推送效果统计
- [ ] 错误日志收集
- [ ] 性能指标监控

## 📞 技术支持

如果在测试过程中遇到问题，请：

1. 查看控制台日志
2. 检查网络连接
3. 验证配置文件
4. 参考官方文档: https://docs.expo.dev/push-notifications/
5. 联系技术支持团队
